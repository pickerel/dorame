var WIN_STAT_FILE="saaa-win.txt";var air_win=function(C,A,B){this.win_handle=window.nativeWindow;this.win_id=A;this.layout=B;this.parent_win=C;var D=(new DOMParser()).parseFromString(air.NativeApplication.nativeApplication.applicationDescriptor,"text/xml");this.application_name=D.getElementsByTagName("name")[0].childNodes[0].data;this.application_version=D.getElementsByTagName("version")[0].childNodes[0].data;this.application_id=D.getElementsByTagName("id")[0].childNodes[0].data;if(this.parent_win!=null){this.parent_win.add_child(this)}};var air_win_buttons=function(){this.maximize=null;this.minimize=null;this.restore=null;this.always_on_top=null;this.disable_always_on_top=null;this.tray=null;this.resize=null;this.change_theme=null;this.move=null;this.parent_win=null};var air_win_event_handles=function(){this.maximize=new array_list();this.minimize=new array_list();this.restore=new array_list();this.always_on_top=new array_list();this.disable_always_on_top=new array_list();this.tray=new array_list();this.resize=new array_list();this.resized=new array_list();this.theme_change=new array_list();this.move=new array_list();this.moved=new array_list();this.close=new array_list()};air_win.prototype={win_handle:null,win_id:null,stateless:false,theme:"default",layout:null,buttons:new air_win_buttons(),event_listeners:new air_win_event_handles(),application_name:null,application_version:null,application_id:null,_position:{x:null,y:null,height:null,width:null},always_on_to:false,};air_win.prototype.debug=function(A){air.trace(this.win_id+":"+A)};air_win.prototype.get_state_file=function(){return this.win_id+"."+this.application_id+"."+WIN_STAT_FILE};air_win.prototype.restore_state=function(){if(this.stateless){return }var A;try{A=saaa_util.file.read(this.get_state_file())}catch(B){this.debug("read position data failed:"+B)}if(A){this._position.x=A.x;this._position.y=A.y;this._position.width=this.win_handle.width;this._position.height=this.win_handle.height;if(A.is_maximize){this.on_maximize()}this.win_handle.alwaysInFront=A.is_always_top;this.theme=A.theme;this.set_position(this._position)}};air_win.prototype.is_maximize=function(){return this.win_handle.displayState==air.NativeWindowDisplayState.MAXIMIZED};air_win.prototype.is_minimize=function(){return this.win_handle.displayState==air.NativeWindowDisplayState.MINIMIZED};air_win.prototype.set_position=function(A){this.debug("set position "+A.x+" "+A.y);var B=this.win_handle;B.x=A.x;B.y=A.y;B.height=A.height;B.width=A.width};air_win.prototype.update_position=function(){var A=this.win_handle;this._position.x=A.x;this._position.y=A.y;this._position.width=A.width;this._position.height=A.height};air_win.prototype.apply_theme=function(A){if(!this.layout){return }this.debug("apply theme "+A);this.theme=A;this.layout.attr("class",A+"-theme")};air_win.prototype.store_state=function(){if(this.stateless){return }var C=this.theme;var A=this.win_handle;var B=this._position;this.debug("store state:x="+B.x+" y="+B.y+" width="+B.width+" height="+B.height+" maximize="+this.is_maximize()+" always_top="+A.alwaysInFront+" theme="+C);saaa_util.file.write(this.get_state_file(),{x:B.x,y:B.y,width:B.width,height:B.height,is_maximize:this.is_maximize(),is_always_top:A.alwaysInFront,theme:C})};air_win.prototype._show_buttons=function(){var A=this.win_handle;var B=this.buttons;if(B.minimize){B.minimize.show()}if(B.close){B.close.show()}if(B.resize){B.resize.show()}if(B.move){B.move.show()}if(B.change_theme){B.change_theme.show()}if(B.always_on_top){B.always_on_top.show()}if(B.disable_always_on_top){B.disable_always_on_top.show()}if(B.tray){B.tray.show()}this.debug("this.max:"+this.is_maximize());if(B.maximize&&this.is_maximize()){B.restore.show();B.maximize.hide()}else{if(B.restore){B.restore.hide();B.maximize.show()}}if(B.always_on_top&&A.alwaysInFront){B.disable_always_on_top.show();B.always_on_top.hide()}else{if(B.disable_always_on_top&&B.disable_always_on_top){B.disable_always_on_top.hide();B.always_on_top.show()}}if(B.change_theme){B.change_theme.show()}};air_win.prototype.init=function(){if(!this.stateless){this.restore_state()}if(!this.is_maximize()&&!this.is_minimize){this.update_position()}this.apply_theme(this.theme);this._show_buttons();this.attach_events();this.debug("initialized.")};air_win.prototype.show=function(A){this.win_handle.visible=true;if(A==null){this.layout.fadeIn()}else{A(this.layout)}};air_win.prototype.on_minimize=function(){var A=new air.NativeWindowDisplayStateEvent(air.NativeWindowDisplayStateEvent.DISPLAY_STATE_CHANGING,true,true,this.win_handle.displayState,air.NativeWindowDisplayState.MINIMIZED);this.win_handle.dispatchEvent(A);if(!A.isDefaultPrevented()){this.win_handle.minimize()}this._call_event_listeners(this.event_listeners.minimize,function(B){B()});this.debug("event - minimize.");return false};air_win.prototype.on_maximize=function(){var A=new air.NativeWindowDisplayStateEvent(air.NativeWindowDisplayStateEvent.DISPLAY_STATE_CHANGING,true,true,this.win_handle.displayState,air.NativeWindowDisplayState.MAXIMIZED);this.win_handle.dispatchEvent(A);if(!A.isDefaultPrevented()){this.win_handle.maximize()}this._call_event_listeners(this.event_listeners.maximize,function(B){B()});this.debug("event - maximize.");return false};air_win.prototype.on_restore=function(B){var A=new air.NativeWindowDisplayStateEvent(air.NativeWindowDisplayStateEvent.DISPLAY_STATE_CHANGING,true,true,this.win_handle.displayState,air.NativeWindowDisplayState.NORMAL);this.win_handle.dispatchEvent(A);if(!A.isDefaultPrevented()){this.win_handle.restore()}this._call_event_listeners(this.event_listeners.restore,function(C){C()});this.debug("event - restore.");return false};air_win.prototype.on_change_theme=function(B){this.theme=$(B).attr("theme");this.debug("theme is "+this.theme);this.apply_theme(this.theme);this.store_state();var A=this.theme;this._call_event_listeners(this.event_listeners.theme_change,function(C){C(A)});this.debug("event - change theme to "+this.theme)};air_win.prototype.on_moved=function(){if(this.is_maximize()){return false}this.update_position();this._call_event_listeners(this.event_listeners.moved,function(A){A()});this.store_state();return false};air_win.prototype.on_move=function(){if(this.is_maximize()){return false}this.win_handle.startMove();this._call_event_listeners(this.event_listeners.move,function(A){A()});return false};air_win.prototype.on_resized=function(){if(this.is_maximize()){return false}this.update_position();this._call_event_listeners(this.event_listeners.resized,function(A){A()});this.store_state();return false};air_win.prototype.on_always_top=function(){this.win_handle.alwaysInFront=true;this.buttons.disable_always_on_top.show();this.buttons.always_on_top.hide();this._call_event_listeners(this.event_listeners.always_on_top,function(A){A()});this.store_state();return false};air_win.prototype.on_disable_always_top=function(){this.win_handle.alwaysInFront=false;this.buttons.disable_always_on_top.hide();this.buttons.always_on_top.show();this._call_event_listeners(this.event_listeners.disable_always_on_top,function(A){A()});this.store_state();return false};air_win.prototype.on_resize=function(){if(this.is_maximize()){return false}var A;switch(this.buttons.resize.attr("direction")){case"top_left":A=air.NativeWindowResize.TOP_LEFT;break;case"top_right":A=air.NativeWindowResize.TOP_RIGHT;break;case"bottom_left":A=air.NativeWindowResize.BOTTOM_LEFT;break;default:case"bottom_right":A=air.NativeWindowResize.BOTTOM_RIGHT;break}this.win_handle.startResize(A);this._call_event_listeners(this.event_listeners.resize,function(B){B(A)});return false};air_win.prototype.attach_events=function(){var A=this.win_handle;var C=this.buttons;var B=this;A.addEventListener(air.NativeWindowDisplayStateEvent.DISPLAY_STATE_CHANGE,function(D){if(B.is_maximize()){C.restore.show();C.maximize.hide()}else{C.restore.hide();C.maximize.show()}if(!B.is_minimize()&&!B.is_maximize()){B.update_position()}B.store_state();B.debug("event - display state changed.")});if(C.change_theme){C.change_theme.click(function(){return B.on_change_theme(this)})}if(C.minimize){C.minimize.click(function(){return B.on_minimize()})}if(C.maximize){C.maximize.click(function(){return B.on_maximize()})}if(C.restore){C.restore.click(function(){return B.on_restore()})}if(C.close){C.close.click(function(){return B.on_close()})}if(C.resize){C.resize.mousedown(function(){$("body").one("mouseup",function(){B.on_resized()});return B.on_resize()})}if(C.move){C.move.mousedown(function(){$("body").one("mouseup",function(){B.on_moved()});return B.on_move()})}if(C.always_on_top){C.always_on_top.click(function(){return B.on_always_top()})}if(C.disable_always_on_top){C.disable_always_on_top.click(function(){return B.on_disable_always_top()})}if(C.tray){C.tray.click(function(){return B.on_tray()})}};air_win.prototype.on_tray=function(){this.win_handle.visible=false;this._call_event_listeners(this.event_listeners.tray,function(A){A()});return false};air_win.prototype.on_close=function(){this.debug("closing...");var A=new air.Event(air.Event.CLOSING,true,true);this.win_handle.dispatchEvent(A);this._call_event_listeners(this.event_listeners.close,function(B){B(A)});if(!A.isDefaultPrevented()){this.win_handle.close();this.debug("closed")}return false};var air_win_tray=function(B,A){this.text=null;this.icons=A;this.menu_items=new Array();this.add_menu_item=function(C,D){this.menu_items.push({text:C,callback:D})}};air_win.prototype.install_tray=function(E){var C=function(I){air.NativeApplication.nativeApplication.icon.bitmaps=new runtime.Array(I.target.content.bitmapData)};air.NativeApplication.nativeApplication.autoExit=false;var B=new air.Loader();var D=new air.NativeMenu();var A=this;for(i=0;i<E.menu_items.length;i++){var H=E.menu_items[i];var F=D.addItem(new air.NativeMenuItem(H.text));F.addEventListener(air.Event.SELECT,H.callback)}var G=E.text;if(G==null){G=this.application_name+" "+this.application_version}if(air.NativeApplication.supportsSystemTrayIcon){air.NativeApplication.nativeApplication.autoExit=false;B.contentLoaderInfo.addEventListener(air.Event.COMPLETE,C);B.load(new air.URLRequest(E.icons.icon_16));air.NativeApplication.nativeApplication.icon.tooltip=G;air.NativeApplication.nativeApplication.icon.menu=D}if(air.NativeApplication.supportsDockIcon){B.contentLoaderInfo.addEventListener(air.Event.COMPLETE,C);B.load(new air.URLRequest(E.icons.icon_128));air.NativeApplication.nativeApplication.icon.menu=D}};air_win.prototype.add_event_listener=function(A,B){switch(A){case"maximize":this.event_listeners.maximize.add(B);break;case"minimize":this.event_listeners.minimize.add(B);break;case"restore":this.event_listeners.restore.add(B);break;case"always_on_top":this.event_listeners.always_on_top.add(B);break;case"disable_always_on_top":this.event_listeners.disable_always_on_top.add(B);break;case"tray":this.event_listeners.tray.add(B);break;case"resize":this.event_listeners.resize.add(B);break;case"resized":this.event_listeners.resized.add(B);break;case"theme_change":this.event_listeners.theme_change.add(B);break;case"move":this.event_listeners.move.add(B);break;case"moved":this.event_listeners.moved.add(B);break;case"close":this.event_listeners.close.add(B);break;default:this.debug("unknown event");break}};air_win.prototype.remove_event_listener=function(C,B){var A;switch(C){case"maximize":A=this.event_listeners.maximize;break;case"minimize":A=this.event_listeners.minimize;break;case"restore":A=this.event_listeners.restore;break;case"always_on_top":A=this.event_listeners.always_on_top;break;case"disable_always_on_top":A=this.event_listeners.disable_always_on_top;break;case"tray":A=this.event_listeners.tray;break;case"resize":A=this.event_listeners.resize;break;case"resized":A=this.event_listeners.resized;break;case"theme_change":A=this.event_listeners.theme_change;break;case"move":A=this.event_listeners.move;break;case"moved":A=this.event_listeners.moved;break;case"close":A=this.event_listeners.close;break;default:this.debug("unknown event");break}if(A!=null){A.remove_at(A.index_of(B,0))}};air_win.prototype.exit=function(){air.NativeApplication.nativeApplication.icon.bitmaps=[];air.NativeApplication.nativeApplication.exit()};air_win.prototype._call_event_listeners=function(B,D){for(var A=0;A<B.count();A++){var C=B.get_at(A);D(C)}};air_win.prototype.add_child=function(C){var A=this;C.theme=this.theme;var B=function(D){C.apply_theme(D)};this.add_event_listener("theme_change",B);C.add_event_listener("close",function(){A.remove_event_listener("theme_change",B)})};air_win.prototype.load_sandbox=function(K,B,A,F,E,G,D,J){var H='<iframe id="'+B+'" sandboxRoot="'+F+'" documentRoot="'+E+'"></iframe>';K.html(H);var C=$("#"+B);C.attr("src",A);var I=new sandbox_bridge(B);C.attr("ondominitialize",function(){I.init();I.attach(parent_bridge);if(G!=null){G(C,I)}});if(J==null){J={}}J.parent_win=this;C.one("load",function(){if(!I.inited){I.init()}I.init_child(J);if(D!=null){D(C,I)}})};